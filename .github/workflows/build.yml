name: Alpine x86_64 Auto Build
on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        default: false
        description: '启用调试模式'
jobs:
  auto-build:
    runs-on: ubuntu-latest
    container: alpine:3.23
    steps:
      - name: 基础环境初始化
        run: |
          apk update && apk add --no-cache git file coreutils
          mkdir -p /app /build

      - name: 拉取源码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 智能检测源码类型
        id: detect-lang
        run: |
          if [ -f "go.mod" ]; then
            echo "lang=go" >> $GITHUB_OUTPUT
          elif [ -f "CMakeLists.txt" ]; then
            echo "lang=cmake" >> $GITHUB_OUTPUT
          elif [ -f "configure" ]; then
            echo "lang=configure" >> $GITHUB_OUTPUT
          elif [ -f "configure.ac" ] || [ -f "autogen.sh" ]; then
            echo "lang=autogen" >> $GITHUB_OUTPUT
          else
            echo "::error::未检测到支持的编译类型"
            exit 1
          fi

      - name: 安装Go编译依赖 & 编译
        if: steps.detect-lang.outputs.lang == 'go'
        run: |
          apk add --no-cache go
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o /app/app-alpine-x86_64
          chmod +x /app/app-alpine-x86_64
          file /app/app-alpine-x86_64

      - name: 安装CMake编译依赖 & 编译
        if: steps.detect-lang.outputs.lang == 'cmake'
        run: |
          apk add --no-cache build-base musl-dev gcc g++ cmake make linux-headers
          mkdir -p build && cd build
          cmake .. -DCMAKE_INSTALL_PREFIX=/app \
                   -DCMAKE_C_COMPILER=musl-gcc \
                   -DCMAKE_CXX_COMPILER=musl-g++ \
                   -DCMAKE_SYSTEM_PROCESSOR=x86_64
          make -j$(nproc) && make install
          file $(find /app -type f -executable | head -1)

      - name: 安装configure编译依赖 & 编译
        if: steps.detect-lang.outputs.lang == 'configure'
        run: |
          apk add --no-cache build-base musl-dev gcc g++ make autoconf automake libtool pkgconfig linux-headers
          ./configure --prefix=/app --build=x86_64-linux-musl
          make -j$(nproc) && make install
          file $(find /app -type f -executable | head -1)

      - name: 生成configure & 编译
        if: steps.detect-lang.outputs.lang == 'autogen'
        run: |
          apk add --no-cache build-base musl-dev gcc g++ make autoconf automake libtool pkgconfig linux-headers
          if [ -f "autogen.sh" ]; then
            chmod +x autogen.sh && ./autogen.sh
          else
            autoreconf -vfi
          fi
          ./configure --prefix=/app --build=x86_64-linux-musl
          make -j$(nproc) && make install
          file $(find /app -type f -executable | head -1)

      - name: 调试步骤
        if: github.event_name == 'workflow_dispatch' && inputs.debug_enabled == true
        run: |
          echo "调试模式已启用"
          echo "检测到的语言类型: ${{ steps.detect-lang.outputs.lang }}"
          echo "当前目录内容:"
          ls -la
          echo "App目录内容:"
          find /app -type f -print

      - name: 产物瘦身 & 统一归档
        run: |
          find /app -type f -executable -exec strip {} \; 2>/dev/null || true
          tar -zcvf /build/alpine-x86_64-build-$(date +%Y%m%d).tar.gz /app
          echo "编译产物已打包：$(ls /build/*.tar.gz)"
          echo "产物内可执行文件：$(find /app -type f -executable | wc -l) 个"

      - name: 上传产物到GitHub Artifact
        uses: actions/upload-artifact@v4
        with:
          name: alpine-x86_64-compile-result
          path: /build/*.tar.gz
          retention-days: 7