name: OpenList Alpine x86_64 编译
on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        default: false
        description: '启用调试模式'
jobs:
  compile-openlist:
    runs-on: ubuntu-latest
    container: alpine:3.23
    steps:
      - name: 初始化环境
        run: |
          apk update && apk add --no-cache git file coreutils
          mkdir -p /app /build

      - name: 拉取源码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 改为完整克隆，解决VCS问题

      - name: 安装Go编译环境
        run: |
          apk add --no-cache go gcc g++ musl-dev linux-headers
          go version
          go env

      - name: 编译OpenList
        run: |
          cd /__w/openlist/openlist  # GitHub Actions的标准工作目录
          
          # 设置Go模块代理（加速下载）
          go env -w GOPROXY=https://goproxy.cn,direct
          go env -w GOSUMDB=off
          
          # 下载依赖并编译（禁用VCS检查，使用静态编译）
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
          go build -trimpath -ldflags="-s -w -extldflags '-static' -buildvcs=false" \
          -o /app/openlist-alpine-x86_64 ./cmd/openlist
          
          # 验证编译结果
          chmod +x /app/openlist-alpine-x86_64
          file /app/openlist-alpine-x86_64
          ldd /app/openlist-alpine-x86_64 2>/dev/null || echo "静态编译，无动态依赖"

      - name: 备用编译方式（如果主入口不对）
        if: failure()
        run: |
          cd /__w/openlist/openlist
          
          # 查找Go项目的主入口
          echo "查找Go项目入口点..."
          find . -name "*.go" -type f | head -20
          
          # 尝试不同的入口点
          if [ -f "./main.go" ]; then
            echo "找到main.go，尝试编译..."
            CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
            go build -trimpath -ldflags="-s -w -extldflags '-static' -buildvcs=false" \
            -o /app/openlist-alpine-x86_64 .
          elif [ -d "./cmd" ]; then
            echo "找到cmd目录，列出可编译目标..."
            for cmd in ./cmd/*; do
              if [ -d "$cmd" ]; then
                echo "尝试编译: $cmd"
                CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
                go build -trimpath -ldflags="-s -w -extldflags '-static' -buildvcs=false" \
                -o /app/openlist-alpine-x86_64 "$cmd"
                break
              fi
            done
          fi
          
          if [ -f "/app/openlist-alpine-x86_64" ]; then
            chmod +x /app/openlist-alpine-x86_64
            file /app/openlist-alpine-x86_64
          fi

      - name: 产物处理
        run: |
          # 如果编译成功，处理产物
          if [ -f "/app/openlist-alpine-x86_64" ]; then
            strip /app/openlist-alpine-x86_64 2>/dev/null || true
            tar -zcvf /build/openlist-alpine-x86_64-$(date +%Y%m%d-%H%M%S).tar.gz -C /app .
            echo "编译成功！"
            echo "文件信息:"
            file /app/openlist-alpine-x86_64
            echo "文件大小: $(du -h /app/openlist-alpine-x86_64 | cut -f1)"
          else
            echo "::error::编译失败，未生成可执行文件"
            exit 1
          fi

      - name: 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: openlist-alpine-x86_64
          path: /build/*.tar.gz
          retention-days: 7