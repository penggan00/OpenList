name: Alpine Builds

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        type: choice
        description: 'Build type'
        required: true
        default: 'standard'
        options:
        - standard
        - lite

jobs:
  alpine-build:
    name: Alpine ${{ github.event.inputs.build_type || 'standard' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0'

      - name: Install Alpine Build Tools
        run: |
          # 下载Alpine的静态编译工具链
          wget http://dl-cdn.alpinelinux.org/alpine/v3.23/main/x86_64/apk-tools-static-2.14.0-r2.apk
          tar -xzf apk-tools-static-2.14.0-r2.apk
          
          # 创建Alpine构建环境
          mkdir -p alpine-build
          cd alpine-build

      - name: Cross-compile for Alpine (static musl)
        run: |
          # 设置交叉编译环境
          export CC=x86_64-linux-musl-gcc
          export CXX=x86_64-linux-musl-g++
          
          # 构建标志
          if [ '${{ github.event.inputs.build_type }}' = 'lite' ]; then
            BUILD_TAGS='-tags=lite'
            BUILD_TYPE='lite'
          else
            BUILD_TAGS=''
            BUILD_TYPE='standard'
          fi
          
          # 静态编译
          CGO_ENABLED=1 \
          GOOS=linux \
          GOARCH=amd64 \
          CC=x86_64-linux-musl-gcc \
          CXX=x86_64-linux-musl-g++ \
          go build $BUILD_TAGS \
            -trimpath \
            -ldflags="-s -w -extldflags '-static'" \
            -buildvcs=false \
            -o openlist-alpine .
          
          chmod +x openlist-alpine
          
          # 验证
          file openlist-alpine
          ls -lh openlist-alpine

      - name: Compress and Package
        run: |
          cd alpine-build
          BUILD_TYPE='${{ github.event.inputs.build_type || 'standard' }}'
          
          # 使用UPX压缩
          if command -v upx &> /dev/null; then
            upx --best --lzma -q openlist-alpine -o openlist-alpine-compressed
            mv openlist-alpine-compressed openlist-alpine
          fi
          
          # 打包
          tar -czf openlist-alpine-$BUILD_TYPE.tar.gz openlist-alpine
          sha256sum openlist-alpine-$BUILD_TYPE.tar.gz > openlist-alpine-$BUILD_TYPE.tar.gz.sha256
          
          echo "Artifacts created:"
          ls -lh *.tar.gz *.sha256

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openlist-alpine-${{ github.event.inputs.build_type || 'standard' }}
          path: alpine-build/openlist-alpine-*.tar.gz*
          retention-days: 30
