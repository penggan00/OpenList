name: OpenList Alpine x86_64 Build
on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      debug:
        type: boolean
        default: false
        description: 'Enable debug mode'
jobs:
  compile-openlist:
    runs-on: ubuntu-latest
    container: alpine:3.23
    steps:
      - name: Setup Environment
        run: |
          apk update && apk add --no-cache git file coreutils
          mkdir -p /app /build

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Go and Dependencies
        run: |
          apk add --no-cache go gcc g++ musl-dev linux-headers
          go version

      - name: Configure Go Environment
        run: |
          # GitHub环境使用默认代理
          go env -w GOPROXY=https://proxy.golang.org,direct
          go env -w GOSUMDB=on
          go env -w GO111MODULE=on
          
          echo "Go environment:"
          go env | grep -E "GOPROXY|GOSUMDB|GO111MODULE"

      - name: Check Project Structure
        run: |
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          
          if [ -f "go.mod" ]; then
            echo "Found go.mod:"
            head -10 go.mod
            echo "Module: $(grep '^module' go.mod)"
          else
            echo "::error::No go.mod found"
            exit 1
          fi

      - name: Download Dependencies
        run: |
          echo "Downloading Go modules..."
          
          # 尝试下载依赖，如果失败显示具体错误
          go mod download 2>&1 | tee /tmp/mod-download.log || {
            echo "::warning::go mod download failed, trying go mod tidy..."
            go mod tidy 2>&1 | tee /tmp/mod-tidy.log || true
          }
          
          # 检查是否成功
          if [ -f "go.sum" ]; then
            echo "Dependencies downloaded successfully"
            echo "go.sum size: $(wc -l go.sum) lines"
          else
            echo "::warning::go.sum not created, dependencies may be missing"
          fi

      - name: Build OpenList
        run: |
          echo "Building OpenList..."
          
          # 查找main包
          echo "Finding main packages..."
          MAIN_PACKAGES=$(find . -name "*.go" -type f -exec grep -l "func main()" {} \; | head -5)
          
          if [ -n "$MAIN_PACKAGES" ]; then
            echo "Main packages found:"
            echo "$MAIN_PACKAGES"
            
            # 尝试编译第一个找到的main包
            FIRST_MAIN=$(echo "$MAIN_PACKAGES" | head -1)
            MAIN_DIR=$(dirname "$FIRST_MAIN")
            
            echo "Building from: $MAIN_DIR"
            
            CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
            go build -trimpath -ldflags="-s -w -extldflags '-static' -buildvcs=false" \
            -o /app/openlist-alpine-x86_64 "./$MAIN_DIR"
          else
            echo "No main packages found, trying to build from root..."
            
            # 尝试从根目录构建
            CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
            go build -trimpath -ldflags="-s -w -extldflags '-static' -buildvcs=false" \
            -o /app/openlist-alpine-x86_64 .
          fi
          
          # 验证构建结果
          if [ -f "/app/openlist-alpine-x86_64" ]; then
            chmod +x /app/openlist-alpine-x86_64
            echo "Build successful!"
            file /app/openlist-alpine-x86_64
            ls -lh /app/openlist-alpine-x86_64
          else
            echo "::error::Build failed - no executable created"
            
            # 尝试更详细的错误信息
            echo "Trying to build with verbose output..."
            CGO_ENABLED=1 GOOS=linux GOARCH=amd64 \
            go build -v -x -o /app/test-build . 2>&1 | tail -50
            
            exit 1
          fi

      - name: Debug Info
        if: github.event_name == 'workflow_dispatch' && inputs.debug == true
        run: |
          echo "=== DEBUG INFORMATION ==="
          echo "Go version: $(go version)"
          echo "Go env:"
          go env
          echo "Directory tree (Go files):"
          find . -name "*.go" -type f | head -30
          echo "go.mod dependencies:"
          grep -E "^\t" go.mod || echo "No dependencies listed"
          echo "Network check:"
          curl -I https://proxy.golang.org --connect-timeout 5 || echo "Network test failed"

      - name: Process Artifacts
        run: |
          if [ -f "/app/openlist-alpine-x86_64" ]; then
            echo "Processing artifact..."
            
            # Strip binary
            strip /app/openlist-alpine-x86_64 2>/dev/null || true
            
            # Create distribution package
            mkdir -p /dist
            cp /app/openlist-alpine-x86_64 /dist/
            
            # Create info file
            cat > /dist/build-info.txt << EOF
            OpenList Alpine x86_64 Build
            Build time: $(date)
            Build environment: Alpine 3.23
            Architecture: x86_64/amd64
            File info: $(file /app/openlist-alpine-x86_64)
            File size: $(stat -c%s /app/openlist-alpine-x86_64) bytes
            EOF
            
            # Package
            tar -zcvf /build/openlist-alpine-x86_64-$(date +%Y%m%d-%H%M%S).tar.gz -C /dist .
            
            echo "Artifact created:"
            ls -lh /build/*.tar.gz
          else
            echo "::error::No artifact to process"
            exit 1
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openlist-alpine-x86_64
          path: /build/*.tar.gz
          retention-days: 7
