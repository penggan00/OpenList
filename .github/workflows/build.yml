name: Alpine Builds

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        type: choice
        description: 'Build type'
        required: true
        default: 'standard'
        options:
        - standard
        - lite

jobs:
  alpine-build:
    name: Alpine ${{ github.event.inputs.build_type || 'standard' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0'

      - name: Install musl交叉编译工具
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Configure Build Environment
        run: |
          if [ '${{ github.event.inputs.build_type }}' = 'lite' ]; then
            echo "BUILD_TAGS=lite" >> $GITHUB_ENV
            echo "BUILD_TYPE=lite" >> $GITHUB_ENV
          else
            echo "BUILD_TAGS=" >> $GITHUB_ENV
            echo "BUILD_TYPE=standard" >> $GITHUB_ENV
          fi

      - name: Download Go Dependencies
        run: |
          go mod download

      - name: Build for Alpine (static musl)
        run: |
          echo "编译Alpine静态二进制文件..."
          
          # 编译Alpine可执行文件（静态musl）
          CGO_ENABLED=1 \
          GOOS=linux \
          GOARCH=amd64 \
          CC=x86_64-linux-musl-gcc \
          CXX=x86_64-linux-musl-g++ \
          go build \
            -trimpath \
            -ldflags="-s -w -extldflags '-static'" \
            -buildvcs=false \
            -tags="$BUILD_TAGS" \
            -o openlist-alpine-x86_64 .
          
          if [ $? -eq 0 ]; then
            echo "编译成功!"
            chmod +x openlist-alpine-x86_64
            
            # 验证
            echo "=== 文件验证 ==="
            echo "文件类型:"
            file openlist-alpine-x86_64
            echo -e "\n链接检查:"
            ldd openlist-alpine-x86_64 2>&1 || echo "✓ 静态链接（musl）"
            echo -e "\nELF信息:"
            readelf -h openlist-alpine-x86_64 | grep -E "(Class|Machine|Type)"
          else
            echo "::error::编译失败"
            exit 1
          fi

      - name: Create Direct Alpine Binary Package
        run: |
          echo "创建Alpine专用包..."
          
          # 创建Alpine专用目录
          mkdir -p alpine-package
          
          # 复制二进制文件
          cp openlist-alpine-x86_64 alpine-package/openlist
          
          # 创建Alpine安装脚本
          cat > alpine-package/install-alpine.sh << 'EOF'
          #!/bin/sh
          # OpenList Alpine安装脚本
          
          echo "正在安装OpenList到Alpine系统..."
          
          # 检查系统
          if ! grep -q "Alpine" /etc/os-release 2>/dev/null; then
              echo "警告：这似乎不是Alpine系统"
              echo "此二进制文件专为Alpine Linux优化"
          fi
          
          # 安装到系统路径
          INSTALL_PATH="/usr/local/bin"
          
          if [ "$(id -u)" -eq 0 ]; then
              cp openlist "$INSTALL_PATH/openlist"
              chmod 755 "$INSTALL_PATH/openlist"
              echo "✓ 已安装到 $INSTALL_PATH/openlist"
              
              # 创建符号链接
              ln -sf "$INSTALL_PATH/openlist" "$INSTALL_PATH/ol" 2>/dev/null || true
              
              echo "安装完成！"
              echo "使用方法: openlist 或 ol"
          else
              echo "需要root权限安装到系统目录"
              echo "请使用: sudo sh install-alpine.sh"
              exit 1
          fi
          EOF
          
          chmod +x alpine-package/install-alpine.sh
          
          # 创建Alpine兼容的tar包
          cd alpine-package
          tar -czf ../openlist-alpine-bin.tar.gz *
          cd ..
          
          # 创建更简单的包（仅二进制）
          tar -czf openlist-alpine-binary-only.tar.gz openlist-alpine-x86_64
          
          echo "生成的文件:"
          ls -lh openlist-alpine-*.tar.gz

      - name: Create Distribution Package
        run: |
          echo "创建完整分发包..."
          
          # 创建标准分发目录
          mkdir -p dist/alpine-x86_64
          
          # 复制所有文件
          cp openlist-alpine-x86_64 dist/alpine-x86_64/
          cp alpine-package/install-alpine.sh dist/alpine-x86_64/ 2>/dev/null || true
          
          # 创建版本信息
          cat > dist/alpine-x86_64/VERSION << EOF
          OpenList Alpine Build
          Version: ${{ github.sha }}
          Build Type: ${{ env.BUILD_TYPE }}
          Build Date: $(date)
          Platform: Alpine Linux x86_64 (musl)
          Architecture: amd64
          Static: yes
          Compressed: no
          EOF
          
          # 打包
          cd dist/alpine-x86_64
          tar -czf ../openlist-alpine-x86_64-${{ env.BUILD_TYPE }}.tar.gz .
          
          # 生成校验和
          cd ..
          sha256sum openlist-alpine-x86_64-${{ env.BUILD_TYPE }}.tar.gz > openlist-alpine-x86_64-${{ env.BUILD_TYPE }}.tar.gz.sha256
          
          echo "分发包内容:"
          tar -tzf openlist-alpine-x86_64-${{ env.BUILD_TYPE }}.tar.gz

      - name: Compress with UPX (可选)
        run: |
          echo "使用UPX压缩..."
          sudo apt-get install -y upx || true
          
          if command -v upx &> /dev/null; then
            # 压缩主二进制文件
            upx --best --lzma -q openlist-alpine-x86_64 -o openlist-alpine-x86_64-upx
            
            # 创建压缩版包
            mkdir -p dist/compressed
            cp openlist-alpine-x86_64-upx dist/compressed/openlist
            tar -czf dist/openlist-alpine-x86_64-${{ env.BUILD_TYPE }}-upx.tar.gz -C dist/compressed .
            
            sha256sum dist/openlist-alpine-x86_64-${{ env.BUILD_TYPE }}-upx.tar.gz > dist/openlist-alpine-x86_64-${{ env.BUILD_TYPE }}-upx.tar.gz.sha256
            
            echo "压缩前后对比:"
            ls -lh openlist-alpine-x86_64*
          else
            echo "UPX不可用，跳过压缩"
          fi

      - name: Upload All Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openlist-alpine-${{ env.BUILD_TYPE }}-x86_64
          path: |
            openlist-alpine-x86_64
            openlist-alpine-*.tar.gz
            dist/openlist-alpine-*.tar.gz*
          retention-days: 30
