name: Alpine Builds

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      build_type:
        type: choice
        description: 'Build type'
        required: true
        default: 'standard'
        options:
        - standard
        - lite

jobs:
  alpine-build:
    name: Alpine ${{ github.event.inputs.build_type || 'standard' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0'

      - name: Install musl交叉编译工具
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Configure Build Environment
        run: |
          if [ '${{ github.event.inputs.build_type }}' = 'lite' ]; then
            echo "BUILD_TAGS=lite" >> $GITHUB_ENV
            echo "BUILD_TYPE=lite" >> $GITHUB_ENV
          else
            echo "BUILD_TAGS=" >> $GITHUB_ENV
            echo "BUILD_TYPE=standard" >> $GITHUB_ENV
          fi

      - name: Download Go Dependencies
        run: |
          go mod download

      - name: Build for Alpine (static musl)
        run: |
          echo "编译Alpine静态二进制文件..."
          
          # 编译Alpine可执行文件
          CGO_ENABLED=1 \
          GOOS=linux \
          GOARCH=amd64 \
          CC=x86_64-linux-musl-gcc \
          CXX=x86_64-linux-musl-g++ \
          go build \
            -trimpath \
            -ldflags="-s -w -extldflags '-static'" \
            -buildvcs=false \
            -tags="$BUILD_TAGS" \
            -o openlist-alpine .
          
          if [ $? -eq 0 ]; then
            echo "编译成功!"
            chmod +x openlist-alpine
            
            # 验证
            echo "=== 文件验证 ==="
            file openlist-alpine
          else
            echo "::error::编译失败"
            exit 1
          fi

      - name: Create Alpine APK Package
        run: |
          echo "创建Alpine APK包..."
          
          # 创建APK包结构
          mkdir -p alpine-apk
          mkdir -p alpine-apk/usr/local/bin
          
          # 复制二进制文件
          cp openlist-alpine alpine-apk/usr/local/bin/openlist
          chmod +x alpine-apk/usr/local/bin/openlist
          
          # 创建APKBUILD文件
          cat > alpine-apk/APKBUILD << 'EOF'
          # Contributor: GitHub Actions <actions@github.com>
          # Maintainer: 
          pkgname=openlist
          pkgver=1.0.0
          pkgrel=0
          pkgdesc="OpenList application for Alpine Linux"
          url="https://github.com/YOUR_USERNAME/YOUR_REPO"
          arch="x86_64"
          license="MIT"
          depends=""
          install=""
          source=""
          
          build() {
              # 已预编译，无需构建
              return 0
          }
          
          package() {
              # 安装文件
              mkdir -p "$pkgdir"/usr/local/bin
              install -Dm755 "$srcdir"/usr/local/bin/openlist "$pkgdir"/usr/local/bin/openlist
          }
          EOF
          
          # 创建.post-install脚本
          cat > alpine-apk/usr/local/bin/.post-install << 'EOF'
          #!/bin/sh
          echo "OpenList has been installed to /usr/local/bin/openlist"
          echo "You can now run: openlist"
          EOF
          
          # 创建控制文件
          cat > alpine-apk/.PKGINFO << EOF
          # Generated by GitHub Actions
          pkgname = openlist
          pkgver = 1.0.0-r0
          pkgdesc = OpenList application for Alpine Linux
          url = https://github.com/${{ github.repository }}
          builddate = $(date +%s)
          packager = GitHub Actions <actions@github.com>
          size = $(stat -c%s alpine-apk/usr/local/bin/openlist)
          arch = x86_64
          origin = openlist
          commit = ${{ github.sha }}
          license = MIT
          EOF
          
          echo "APK包结构创建完成"
          tree alpine-apk

      - name: Create .apk file
        run: |
          echo "打包APK文件..."
          
          # 创建数据.tar.gz
          cd alpine-apk
          tar -czf data.tar.gz usr
          
          # 创建控制.tar.gz
          tar -czf control.tar.gz .PKGINFO .post-install 2>/dev/null || tar -czf control.tar.gz .PKGINFO
          
          # 创建apk文件
          echo 2.0 > apk-version
          cat apk-version control.tar.gz data.tar.gz > ../openlist-${{ env.BUILD_TYPE }}-x86_64.apk
          cd ..
          
          # 也可以创建简单的tar.gz包
          tar -czf openlist-alpine-${{ env.BUILD_TYPE }}-install.tar.gz -C alpine-apk/usr/local/bin openlist
          
          echo "生成的包:"
          ls -lh *.apk *.tar.gz

      - name: Create Simple Install Package
        run: |
          echo "创建简易安装包..."
          
          # 方法1: 简单的安装脚本包
          cat > install-openlist-alpine.sh << 'EOF'
          #!/bin/sh
          # OpenList Alpine安装脚本
          
          set -e
          
          BINARY_URL="https://github.com/${{ github.repository }}/releases/latest/download/openlist-alpine-${{ env.BUILD_TYPE }}.tar.gz"
          INSTALL_DIR="/usr/local/bin"
          
          echo "正在安装OpenList到Alpine Linux..."
          
          # 检查是否为Alpine
          if [ ! -f /etc/alpine-release ]; then
              echo "警告: 这不是Alpine Linux系统"
              read -p "继续安装? (y/N): " -n 1 -r
              echo
              if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                  exit 1
              fi
          fi
          
          # 下载并安装
          echo "下载OpenList..."
          wget -q -O /tmp/openlist.tar.gz "$BINARY_URL" || curl -L -o /tmp/openlist.tar.gz "$BINARY_URL"
          
          echo "解压..."
          tar -xzf /tmp/openlist.tar.gz -C /tmp
          
          echo "安装到 $INSTALL_DIR..."
          sudo install -Dm755 /tmp/openlist $INSTALL_DIR/openlist
          
          echo "清理..."
          rm -f /tmp/openlist /tmp/openlist.tar.gz
          
          echo "✓ 安装完成!"
          echo "运行: openlist --help"
          EOF
          
          chmod +x install-openlist-alpine.sh

      - name: Test APK in Alpine Container
        run: |
          echo "在Alpine容器中测试..."
          
          # 创建测试脚本
          cat > test-alpine.sh << 'EOF'
          #!/bin/sh
          echo "=== Alpine容器测试 ==="
          echo "Alpine版本: $(cat /etc/alpine-release)"
          echo "当前目录: $(pwd)"
          ls -la
          
          if [ -f "openlist-alpine" ]; then
              echo "测试二进制文件..."
              chmod +x openlist-alpine
              ./openlist-alpine --version 2>&1 || ./openlist-alpine --help 2>&1 || echo "✓ 二进制文件可执行"
          else
              echo "错误: 未找到二进制文件"
          fi
          EOF
          
          chmod +x test-alpine.sh
          
          # 在Alpine容器中运行测试
          docker run --rm \
            -v $(pwd):/test \
            alpine:3.23 \
            sh -c "cd /test && sh test-alpine.sh"

      - name: Upload All Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: openlist-alpine-${{ env.BUILD_TYPE }}-build
          path: |
            openlist-alpine
            openlist-*.apk
            openlist-*.tar.gz
            install-*.sh
          retention-days: 30
          
      - name: Upload to Release (if triggered by release)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            openlist-*.apk
            openlist-alpine-*.tar.gz
            install-openlist-alpine.sh
          tag_name: ${{ github.event.release.tag_name }}
